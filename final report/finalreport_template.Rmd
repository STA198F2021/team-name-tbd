---
title: "An Investigation of Factors Influencing Emergency Healthcare Expenditures"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Maggie Lundberg, Riya Mohan, and Izzy Kjaerulff"
date: "11/16/2021"
output: pdf_document
---

```{r read_data, warning = FALSE, echo = FALSE}
unzip("../data/IHME_DEX_ED_SPENDING_2006_2016_DATA.zip", exdir =  "../data/spending_data_unzip")

spending <- read.csv("../data/spending_data_unzip/IHME_DEX_ED_SPENDING_2006_2016_DATA_Y2021M09D23.CSV")
```

```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(tidymodels)
``` 

## Abstract


## Gender

Is there a difference in insurance type between males and females? Disclaimer: this study only looked at people who identified as either female or male.

```{r}
spending_malefemale <- spending %>%
  filter(sex %in% c("Female", "Male"))

```


!!should this be moved to where we are looking at the interaction of factors
Here is a boxplot showing the distribution of Emergency Department spending based on disease type and gender. ADD interpretation
```{r gender-diseasetype-barplot}

ggplot(data = spending_malefemale, aes(x = agg_cause, y = mean_all, fill = sex)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Disease Type",
    y = "Government Spending",
    title = "Emergency Department Spending Based on Disease Type and Gender",
    fill = "Gender"
       )

```

First this t-test looks at overall differences in mean emergency department spending between males and females
```{r gender-t-test}
  t.test(spending_malefemale$mean_all~spending_malefemale$sex) %>%
  print()
```

Next, performing a t-test on each type of insurance to see if there is a difference in spending between males and females:
```{r gender-pubspending-ttest}
t.test(spending_malefemale$mean_pub~spending_malefemale$sex) %>%
  print()
```
```{r gender-prispending-ttest}
t.test(spending_malefemale$mean_pri~spending_malefemale$sex) %>%
  print()
```
```{r gender-oopspending-ttest}
t.test(spending_malefemale$mean_oop~spending_malefemale$sex) %>%
  print()
```
All three of these t-tests indicate evidence to reject the null hypothesis that emergency department spending is the same for males and females who have public insurance, private insurance, or pay out of pocket. On average, females pay more than males for each type of emergency department spending. 

## Disease category and gov spending

ANOVA:
null hypothesis: means of spending the same for each disease category
assume outcomes are normally distributed, same variance, and samples are independent
```{r ANOVAtest}
summary(aov(mean_all~agg_cause,data=spending_malefemale))
```

Based on the p-value here of these data or more extreme data it is highly unlikely the null hypothesis is true. Therefore, we perform step-down tests using a Holm correction for multiple comparisons
```{r}
diseasepair <- pairwise.t.test(spending_malefemale$mean_all,    spending_malefemale$agg_cause, p.adj = "holm")
sigpairs <- broom::tidy(diseasepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigpairs)
```
The step-down t tests indicate 61 disease category pairs are different out of ??
## hey i'm just making this blue so you'll see but i'm pretty sure that the possible pairs is just the combination formula with all the fun factorial stuff, so if there are 15 groups as indicated in ur overall test, then there are 105 possible combinations. but also idk if the "all ages" group will mess u up because it changed the response in my age comparison my brain is kinda foggy though
, indicating most disease categories do differ in the amount of government spending by the emergency department. 


## Age

!! had to take out the observations with "All Ages" because I think it will just mess up the pairs but let me know what you think or whether you think there's anything we can do with that group

```{r delete-allages}

spending_noall <- spending_malefemale %>%
  filter(age_group_name != "All Ages")

```


We wonder whether there is a correlation between government healthcare expenditures in the emergency department and age. The age variable is categorical, split into 19 groups that generally include 5 years each, apart from the first (<1 year) and last (85 plus) groups. 

To address this question, we began by using an overall test with ANOVA.

Below is an overall test of the null hypothesis that all of the means for age groups across the years are equal, as opposed to the alternative that at least one mean is different.

```{r age-anova}

summary(aov(mean_all~age_group_name,data = spending_noall))

```

In this F-test (ndf = 18, ddf = 6229), a significant difference among age groups was identified. Our p-value tells us that this data (or data more extreme) would be very unlikely if the null hypothesis were true because it shows statistical significance at an alpha well below 0.05. Therefore, we reject the null hypothesis that the mean expenditures for all age groups are equal.

To see which specific means may be different from one another, we used planned step-down tests with a Holm correction to minimize Type I errors.

```{r age-stepdown}

agepair <- pairwise.t.test(spending_noall$mean_all, spending_noall$age_group_name, p.adj = "holm")
sigagepairs <- broom::tidy(agepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigagepairs)

```

The pairwise t-tests used for our ANOVA step-down tests suggest that there are 97 different age pairs out of the 171 possible combinations. This tells us that more age pairs are different than are similar and that therefore the majority of age group pairs differ in terms of mean expenditures.

```{r age-expenditure-barplot}

ggplot(data = spending_noall, aes(x = age_group_name, y = mean_all)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Age Group",
    y = "Mean Spending of All Payers",
    title = "Emergency Department Expenditures By Age Group"
       )

```

```{r age-pub-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = mean_pub)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Age Group",
    y = "Mean Spending of Public Insurance",
    title = "ED Public Insurance Expenditures By Age Group"
       )

```

```{r age-pri-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = mean_pri)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Age Group",
    y = "Mean Spending of Public Insurance",
    title = "ED Public Insurance Expenditures By Age Group"
       )

```

```{r age-oop-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = mean_oop)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Age Group",
    y = "Mean Spending of Public Insurance",
    title = "ED Public Insurance Expenditures By Age Group"
       )

```