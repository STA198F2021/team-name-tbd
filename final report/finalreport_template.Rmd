---
title: "**An Investigation of Social Factors Influencing <br> Emergency Healthcare Expenditure**"
author: "*Maggie Lundberg, Riya Mohan, Izzy Kjaerulff*"
output:
  pdf_document:
    fig_caption: yes
    fig_crop: no
    highlight: pygments
    keep_tex: no
    toc: yes
    toc_depth: 3
fontsize: 10pt
header-includes:
  \usepackage{float}
  \usepackage{array}
  \usepackage{fancyhdr}
  \usepackage{times}
---

```{r read_data, warning = FALSE, echo = FALSE, message = FALSE, fig.height = 3, fig.width = 3}
unzip("../data/IHME_DEX_ED_SPENDING_2006_2016_DATA.zip", exdir =  "../data/spending_data_unzip")

spending <- read.csv("../data/spending_data_unzip/IHME_DEX_ED_SPENDING_2006_2016_DATA_Y2021M09D23.CSV")
```

```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(tidymodels)

library(knitr)
  opts_chunk$set(fig.align='center',
                 external=TRUE,
                 echo=TRUE,
                 warning=FALSE,
                 fig.pos='H'
                )
``` 


## Abstract

This paper provides insight into an open investigation of personal healthcare spending in the United States, with focus on the emergency department (ED). We used data from the Disease Expenditure Project (DEX) at IHME, giving estimates for ED spending split into three major groups: public insurance, private insurance, and out of pocket. The data compiled is used to investigate the existence of a relationship between demographic (sex and age), disease, and expenditure. In the following report, we hypothesize demographic, disease, and type of expenditure from our three included groups are not independent of one another. For example, we expect that results will suggest that public healthcare spending will be higher in older populations when compared to younger populations, whereas private spending will be higher in those younger populations. From the analysis devised in this report, we gather that the data is consistent with the following conclusions: [INSERT CONCLUSIONS HERE]

\newpage

## Background & Significance

Emergency services ensure that individuals can receive timely care for unexpected ailments and injuries, making them a vital component of the healthcare industry. In recent years, however, emergency service spending has seen a significant increase (Scott and Liu 2021), which begs the question of equal accessibility. Expenditure is one of many ways by which to investigate interactions between demographic and healthcare access. [ELABORATE] As a preliminary piece of evaluation of the question of healthcare equity and accessibility by disease and demographic, we have prepared an analysis report of spending habits divided into the payer categories of public insurance, private insurance, and out of pocket. We hope to dive deeper into the relationship between spending habits and demographic through the lens of factors influencing payment models for the emergency department.

## Methods

### Data Collection

Our data is provided by the Institute of Health Metrics and Evaluation as part of the Disease Expenditure Project (DEX). These Emergency Department (ED) health spending data include estimates for U.S. spending on health care divided into three types of payers: public insurance (including Medicare, Medicaid, and other government programs), private insurance, and out-of-pocket payments. This dataset contains ED spending estimates by aggregate health category, age group, sex, and payer for 2006 through 2016, released in October 2021. Data were gathered from “government budgets, insurance claims, facility records, household surveys, and official US records” (IHME 2021). The data collection and agglomeration is funded by the National Institute on Aging (NIA) and the National Institutes of Health (NIH), and estimates were generated from an underlying data set—the National Emergency Department Sample (NEDS).

The data given includes summaries of identified gender and ages as "Both" and "All Ages" observations, respectively. In order to gauge accurate analysis of this data, we chose to exclude the aforementioned observations to avoid double counting.

It is important to acknowledge that this data set did not specify whether gender observations are based on individual reporting or otherwise observed identification and are limited to male and female. Therefore, the data may not encompass a complete representation of the population.

```{r filter-for-gender, echo = FALSE, warning = FALSE, message = FALSE}

spending_malefemale <- spending %>%
  filter(sex %in% c("Female", "Male")) %>%
  filter(age_group_name != "All Ages")

```

*Normal Distribution of Payer Groups*

```{r distribution_pub, echo= FALSE, warning = FALSE, fig.height = 2, fig.width = 2, message = FALSE, fig.show="hold"}
spending_malefemale %>%
  ggplot(aes(x = mean_pub)) +
    geom_histogram(fill = "#28739F") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, face = "italic"),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
  labs(title = NULL,
         x = "Mean Public Spending", 
         y = NULL)

spending_malefemale %>%
  ggplot(aes(x = mean_pri)) +
    geom_histogram(fill = "#28739F") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, face = "italic"),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
  labs(title = NULL,
         x = "Mean Private Spending", 
         y = NULL)

spending_malefemale %>%
  ggplot(aes(x = mean_oop)) +
    geom_histogram(fill = "#28739F") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, face = "italic"),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
  labs(title = NULL,
         x = "Mean Out of Pocket Spending", 
         y = NULL)

```
The normal distribution for public spending, private spending, and out-of-pocket pending all show a severe right skew in the data. Therefore, all three variables do not meet the normal distribution assumption needed for many tests, such as ANOVA; however, this can easily be resolved by applying a log transformation to the data to give a fairly normal distribution of the data.

*Normal Distribution of Payer Groups, Ln Applied*

```{r log_pub, echo= FALSE, warning = FALSE, fig.height = 2, fig.width = 2, message = FALSE, fig.show = "hold"}
spending_malefemale %>%
  ggplot(aes(x = log(mean_pub))) +
    geom_histogram(fill = "#28739F") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, face = "italic"),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
    labs(title = NULL,
         x = "Mean Public Spending (ln)", 
         y = NULL)

spending_malefemale %>%
  ggplot(aes(x = log(mean_pri))) +
    geom_histogram(fill = "#28739F") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, face = "italic"),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
    labs(title = NULL,
         x = "Mean Private Spending (ln)", 
         y = NULL)

spending_malefemale %>%
  ggplot(aes(x = log(mean_oop))) +
    geom_histogram(fill = "#28739F") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, face = "italic"),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
    labs(title = NULL,
         x = "Mean Out-of-Pocket Spending (ln)", 
         y = NULL)

```
These graphs of the log distribution of the various spending means appear to be fairly normal in distribution, which means they meet the requirements to be used in various analyses. In order to convert to log scale, those with mean_all, mean_pub, mean_pri, and mean_oop equal to zero must be excluded.

```{r logscaleconversion, echo= FALSE, warning = FALSE, message = FALSE}
spending_malefemale <- spending_malefemale %>%
  filter(mean_all != 0) %>%
  filter(mean_pub != 0) %>%
  filter(mean_pri != 0) %>%
  filter(mean_oop != 0) %>%
  mutate(lmean_all = log(mean_all)) %>%
  mutate(lmean_pub = log(mean_pub)) %>%
  mutate(lmean_pri = log(mean_pri)) %>%
  mutate(lmean_oop = log(mean_oop))
  
```

### Exploratory Data Analysis

#### Gender


Our first question in this analysis is if males and females spend a different amount of money on emergency services.

First this t-test looks at overall differences in log mean emergency department spending between males and females
```{r gender-t-test, echo= FALSE, warning = FALSE, message = FALSE}
  t.test(spending_malefemale$lmean_all~spending_malefemale$sex) %>%
  print()
```
This t-test shows that for mean spending of all emergency services payment types, the p value of 0.1543 (95% CI -0.0315862, 0.1996079) indicates there is not a significant difference between male and female spending. 

Next, we perform a t-test on each type of insurance to see if there is a difference in spending between males and females:
```{r gender-pubspending-ttest, echo= FALSE, warning = FALSE, message = FALSE}
t.test(spending_malefemale$lmean_pub~spending_malefemale$sex) %>%
  print()
```
The t-test on emergency services spending for people who have public insurance indicates there is not a significant difference between male and female spending, with p value of 0.0697 (95% CI -0.00833746, 0.21532602).
```{r gender-prispending-ttest, echo= FALSE, warning = FALSE, message = FALSE}
t.test(spending_malefemale$lmean_pri~spending_malefemale$sex) %>%
  print()
```
The t-test on emergency services spending for people who have private insurance indicates there is not a significant difference between male and female spending, with p value of 0.4803 (95% CI -0.08283085, 0.17603825).
```{r gender-oopspending-ttest, echo= FALSE, warning = FALSE, message = FALSE}
t.test(spending_malefemale$lmean_oop~spending_malefemale$sex) %>%
  print()
```
The t-test on emergency services spending for people who pay out of pocket indicates there is not a significant difference between male and female spending, with p value of 0.3272 (95% CI -0.0615859, 0.1846904).

The t-tests for each type of insurance indicate that there is not enough evidence to reject the null hypothesis that emergency department spending is the same for males and females who have public insurance, private insurance, or pay out of pocket, leading us to the conclusion that gender does not influence emergency spending in the forms of payment studied here. 

#### Disease


In order to determine emergency department spending based on disease type, an ANOVA test is performed due to the data for spending on the log scale being normally distributed, relatively similar variance, and independent. 

The null hypothesis for this ANOVA test is that the overall mean of spending are the same for each disease category

```{r ANOVAtest, echo= FALSE, warning = FALSE, message = FALSE}
summary(aov(lmean_all~agg_cause,data=spending_malefemale))
```

Based on the p-value here of <2e-16, these data or more extreme data it is highly unlikely the null hypothesis is true. Therefore, we perform step-down tests using a Holm correction for multiple comparisons.
```{r disease_pair, echo= FALSE, warning = FALSE, message = FALSE}
diseasepair <- pairwise.t.test(spending_malefemale$lmean_all,    spending_malefemale$agg_cause, p.adj = "holm")
sigpairs <- broom::tidy(diseasepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigpairs)
```
The step-down t tests indicate 92 disease category pairs are different out of 105, indicating most disease categories do differ in the amount of government spending by the emergency department. There is lots of variation!!


```{r disease_fit, echo= FALSE, warning = FALSE, message = FALSE}
meanalldiseasecatfit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_all ~ agg_cause, data = spending_malefemale)
  tidy(meanalldiseasecatfit)

```
```{r}
glance(meanalldiseasecatfit)$adj.r.squared
```

```{r spending_time_graph, echo = FALSE, warning = FALSE, message = FALSE}
spending_malefemale %>%
  ggplot(aes(x = year_id,
             y = lmean_all,
             fill = agg_cause)) +
  geom_bar(stat = "identity") +
  facet_wrap(~agg_cause) +
  theme(axis.text.x = element_text(angle = 45,hjust = 1), legend.position = "none") +
  labs(x = "Disease Category",
       y = "Mean Spending (log$)")
```


```{r spending_time_fit, echo = FALSE, warning = FALSE, message = FALSE}
spending_malefemale_year <- spending_malefemale %>%
  filter(year_id %in% c("2006", "2016"))
spendingovertime_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_all ~ as.factor(year_id) * agg_cause, data = spending_malefemale_year)
tidy(spendingovertime_fit)

```
```{r}
glance(spendingovertime_fit)$adj.r.squared
```


#### Age


!! had to take out the observations with "All Ages" because I think it will just mess up the pairs but let me know what you think or whether you think there's anything we can do with that group

```{r delete-allages, echo= FALSE, warning = FALSE, message = FALSE}

spending_noall <- spending_malefemale %>%
  filter(age_group_name != "All Ages")

```


We wonder whether there is a correlation between government healthcare expenditures in the emergency department and age. The age variable is categorical, split into 19 groups that generally include 5 years each, apart from the first (<1 year) and last (85 plus) groups. 

To address this question, we began by using an overall test with ANOVA.

Below is an overall test of the null hypothesis that all of the means for age groups across the years are equal, as opposed to the alternative that at least one mean is different.

```{r age-anova, echo= FALSE, warning = FALSE, message = FALSE}

summary(aov(lmean_all~age_group_name,data = spending_noall))

```

In this F-test (ndf = 18, ddf = 6229), a significant difference among age groups was identified. Our p-value tells us that this data (or data more extreme) would be very unlikely if the null hypothesis were true because it shows statistical significance at an alpha well below 0.05. Therefore, we reject the null hypothesis that the mean expenditures for all age groups are equal.

To see which specific means may be different from one another, we used planned step-down tests with a Holm correction to minimize Type I errors.

```{r age-stepdown, echo= FALSE, warning = FALSE, message = FALSE}

agepair <- pairwise.t.test(spending_noall$lmean_all, spending_noall$age_group_name, p.adj = "holm")
sigagepairs <- broom::tidy(agepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigagepairs)

```

The pairwise t-tests used for our ANOVA step-down tests suggest that there are 99 different age pairs out of the 171 possible combinations. This tells us that more age pairs are different than are similar and that therefore the majority of age group pairs differ in terms of mean expenditures.
```{r agefit, message = FALSE}
agefit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_all ~ age_group_name, data = spending_malefemale)
  tidy(agefit)

```


```{r age-expenditure-barplot, echo = FALSE, warning = FALSE, message = FALSE}
  
ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_all)) +
  geom_bar(position = "dodge", stat = "identity", fill = "#4e6e58") +
  theme(
    axis.text.x = element_text(color = "grey20", size = 5, 
                               face = "italic", angle = 45,hjust = 1),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
        ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Age Group",
    y = "Mean Spending of All Payers (log scale)",
    title = "Emergency Department General Expenditures"
       )

```

```{r age-pub-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE, warning = FALSE, message = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_pub)) +
  geom_bar(position = "dodge", stat = "identity", fill = "#4e676e") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
    plot.title = element_text(face="bold"),
    axis.ticks.x = element_blank()
        ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = NULL,
    y = NULL,
    title = "Public Insurance Expenditures"
       )

```

```{r age-pri-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE, warning = FALSE, message = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_pri)) +
  geom_bar(position = "dodge", stat = "identity", fill = "#6a6e4e") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
    plot.title = element_text(face="bold"),
    axis.ticks.x = element_blank()
        ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = NULL,
    y = NULL,
    title = "Private Insurance Expenditures"
       )

```

```{r age-oop-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE, warning = FALSE, message = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_oop)) +
  geom_bar(position = "dodge", stat = "identity", fill = "#6e4e4e") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = "grey20", size = 5, face = "italic"),  
    axis.title.x = element_text(color = "grey20", size = 8, face = "bold"),
    plot.title = element_text(face="bold"),
    axis.ticks.x = element_blank()
        ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = NULL,
    y = NULL,
    title = "Out-of-Pocket Expenditures"
       )

```


#### Gender and Age Interaction


``` {r maineffects_pub, echo = FALSE, warning = FALSE, message = FALSE}
mainefpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ sex + age_group_id, data = spending_malefemale)
tidy(mainefpub_fit)

glance(mainefpub_fit)$adj.r.squared
```

``` {r interaction_pub, echo= FALSE, warning = FALSE}
interpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ sex + age_group_id + sex*age_group_id, data = spending_malefemale)
tidy(interpub_fit)

glance(interpub_fit)$adj.r.squared
```


``` {r maineffects_pri, echo = FALSE, warning = FALSE, message = FALSE}
mainefpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ sex + age_group_id, data = spending_malefemale)
tidy(mainefpri_fit)

glance(mainefpri_fit)$adj.r.squared
```

``` {r interaction_pri, echo = FALSE, warning = FALSE, message = FALSE}
interpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ sex + age_group_id + sex*age_group_id, data = spending_malefemale)
tidy(interpri_fit)

glance(interpri_fit)$adj.r.squared
```



``` {r maineffects_oop, echo = FALSE, warning = FALSE, message = FALSE}
mainefoop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ sex + age_group_id, data = spending_malefemale)
tidy(mainefoop_fit)

glance(mainefoop_fit)$adj.r.squared
```

``` {r interaction_oop, echo = FALSE, warning = FALSE, message = FALSE}
interoop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ sex + age_group_id + sex*age_group_id, data = spending_malefemale)
tidy(interoop_fit)

glance(interoop_fit)$adj.r.squared
```

In order to test the possibility that there is a joint interaction of gender and age, a main effects and interaction effects linear regression model has been fit to the data. As a whole, it shows that the interaction of gender and age slightly increases the accuracy of the regression for public and private spending as seen by the increased adjusted R^2 value. However, for out-of-pocket spending, it decreases the adjusted R^2 value. Nevertheless, overall, the adjusted R^2 values for all three types of spending are incredibly low, which further point to our conclusion that age may not affect the level of spending from different sources.



#### Age and Disease Interaction


```{r rsquared_table, echo = FALSE, warning = FALSE}
Payer <- c("Public Spending", "Private Spending", "Out-of-Pocket Spending")
Main_Effects <- c(0.506887, 0.5054947, 0.5161683)
Interaction <- c(0.529351, 0.5149051, 0.5261024)

models.data <- data.frame(Payer, Main_Effects, Interaction, stringsAsFactors=FALSE)

knitr::kable(models.data, caption="R^2 Values for the Main Effects and Interaction Models Analyzing Disease Type and Age")
```

``` {r agedismain_pub, echo = FALSE, warning = FALSE, message = FALSE}
agedismainpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ agg_cause + age_group_id, data = spending_malefemale)
tidy(agedismainpub_fit)

glance(agedismainpub_fit)$adj.r.squared
```

``` {r agedisinter_pub, echo = FALSE, warning = FALSE, message = FALSE}
agedisinterpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ agg_cause + age_group_id + agg_cause*age_group_id, data = spending_malefemale)

tidy(agedisinterpub_fit)

glance(agedisinterpub_fit$adj.r.squared)
```


``` {r agedismain_pri, echo = FALSE, warning = FALSE, message = FALSE}
agedismainpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ agg_cause + age_group_id, data = spending_malefemale)
tidy(agedismainpri_fit)

glance(agedismainpri_fit)$adj.r.squared
```

``` {r agedisinter_pri, echo = FALSE, warning = FALSE, message = FALSE}
agedisinterpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ agg_cause + age_group_id + agg_cause*age_group_id, data = spending_malefemale)
tidy(agedisinterpri_fit)

glance(agedisinterpri_fit)$adj.r.squared
```



``` {r agedismain_oop, echo = FALSE, warning = FALSE, message = FALSE}
agedismainoop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ agg_cause + age_group_id, data = spending_malefemale)
tidy(agedismainoop_fit)

glance(agedismainoop_fit)$adj.r.squared
```

``` {r agedisinter_oop, echo = FALSE, warning = FALSE, message = FALSE}
agedisinteroop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ agg_cause + age_group_id + agg_cause*age_group_id, data = spending_malefemale)
tidy(agedisinteroop_fit)

glance(agedisinteroop_fit)$adj.r.squared
```

\newpage

## References

Institute for Health Metrics and Evaluation (IHME). United States Healthcare Spending in Emergency Departments by Health Condition 2006-2016. Seattle, United States of America: Institute for Health Metrics and Evaluation (IHME), 2021.

Woody Scott K, Liu A, Chen C, Kaldjian AS, Sabbatini AK, Duber, HC, Dieleman JL. Healthcare Spending in U.S. Emergency Departments by Health Condition, 2006-2016. PLOS One. 27 October 2021.

