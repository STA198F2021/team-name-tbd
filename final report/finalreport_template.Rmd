---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Team TBD: Maggie Lundberg, Riya Mohan, and Izzy Kjaerulff"
date: "11/16/2021"
output: pdf_document
---

Reading Data and Data Clean Up:
```{r read_data, warning = FALSE, echo = FALSE}
unzip("../data/IHME_DEX_ED_SPENDING_2006_2016_DATA.zip", exdir =  "../data/spending_data_unzip")
```
```{r, warning = FALSE}
spending <- read.csv("../data/spending_data_unzip/IHME_DEX_ED_SPENDING_2006_2016_DATA_Y2021M09D23.CSV")
```

```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(tidymodels)
``` 

Emergency spending

## Gender

Does the emergency department spend a different amount of money on males and females? This is looking at all spending, not taking into account type of insurance.

```{r}
spending_malefemale <- spending %>%
  filter(sex %in% c("Female", "Male"))

```

Here is a boxplot showing the distribution of Emergency Department Government spending based on disease type and gender. ADD interpretation
```{r gender-diseasetype-barplot}

ggplot(data = spending_malefemale, aes(x = agg_cause, y = mean_all, fill = sex)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Disease Type",
    y = "Government Spending",
    title = "Emergency Department Spending Based on Disease Type and Gender",
    fill = "Gender"
       )

```

```{r gender-t-test}
  t.test(spending_malefemale$mean_all~spending_malefemale$sex) %>%
  print()
```

Linear regression model for gender and government spending model
```{r gender-lin-reg}

spending_malefemale_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(mean_all~sex, data = spending_malefemale)

```

```{r gender-diseasetype-augment}
augment_spendinggenderfit <- augment(spending_malefemale_fit$fit)
```

```{r resid-plot}
augment_spendinggenderfit %>%
  ggplot(aes(x = .fitted,
             y = .resid)) +
  geom_point() +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(labels = scales::comma) +
  labs(x = "Predicted Government Spending",
       y = "Residual",
       title = "Residual Plot for Linear Regression of Gender and Goverment Spending")
```
The graph of residuals vs the fitted linear lines shows a pattern of clumping around two areas -- slightly above 300,000,000 and slightly below 420,000,000. The clumping pattern indicates a linear model is not a good fit to model the relationship here. 

!!not sure what else to do for gender since the lin regression is so bad

##Disease category and gov spending

ANOVA:
null hypothesis: means of spending the same for each disease category
assume outcomes are normally distributed, same variance, and samples are independent
```{r ANOVAtest}
summary(aov(mean_all~agg_cause,data=spending_malefemale))
```

Based on the p-value here of these data or more extreme data it is highly unlikely the null hypothesis is true. Therefore, we perform step-down tests using a Holm correction for multiple comparisons
```{r}
diseasepair <- pairwise.t.test(spending_malefemale$mean_all,    spending_malefemale$agg_cause, p.adj = "holm")
sigpairs <- broom::tidy(diseasepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigpairs)
```
The step-down t tests indicate 61 disease category pairs are different out of ?? , indicating most disease categories do differ in the amount of government spending by the emergency department. 




## Age

We wonder whether there is a correlation between government healthcare expenditures in the emergency department and age. The age variable is categorical, split into 19 groups that generally include 5 years each, apart from the first (<1 year) and last (85 plus) groups. 

To address this question, we began by rearranging and subsetting our given data set. We collapsed group observations divided by years into one and created two distinct age groups divided at the 45-year mark (below 45 and 45 plus) instead of the original 19. Doing so made it possible to do an F test on the newly defined age groups, which necessitates that there are 2 levels in the grouping factor.

!! trying to figure out how to turn all those groups into 2

```{r age-new-dataset}

age_year_combined <- spending_malefemale %>%
  group_by(age_group_name) %>%
  summarize_at(vars(mean_all),funs(mean(.,na.rm=TRUE))) %>%
  print()

```

```{r age-under45-dataset}

under45 <- age_year_combined %>%
  filter(age_group_name %in% c("<1 year", "1 to 4", "5 to 9", "10 to 14", "15 to 19", "20 to 24", "25 to 29", "30 to 34", "35 to 39", "40 to 44")) %>%
  summarize_at(vars(mean_all),funs(mean(.,na.rm=TRUE))) %>%
  print()

```

```{r age-above45-dataset}

above45 <- age_year_combined %>%
  filter(age_group_name %in% c("45 to 49", "50 to 54", "55 to 59", "60 to 64", "65 to 69", "70 to 74", "75 to 79", "80 to 84", "85 plus")) %>%
  summarize_at(vars(mean_all),funs(mean(.,na.rm=TRUE))) %>%
  print()

```
!! this won't work until there are only 2 levels for the grouping factor 

```{r age-ftest, eval = FALSE}

var.test(mean_all ~ age_group_name, age_year_combined, 
         alternative = "two.sided")

```



