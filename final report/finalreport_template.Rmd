---
title: "An Investigation of Factors Influencing Emergency Healthcare Expenditures"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Maggie Lundberg, Riya Mohan, and Izzy Kjaerulff"
date: "11/16/2021"
output: pdf_document
---

```{r read_data, warning = FALSE, echo = FALSE, fig.height = 3, fig.width = 3}
unzip("../data/IHME_DEX_ED_SPENDING_2006_2016_DATA.zip", exdir =  "../data/spending_data_unzip")

spending <- read.csv("../data/spending_data_unzip/IHME_DEX_ED_SPENDING_2006_2016_DATA_Y2021M09D23.CSV")
```

```{r load-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(tidymodels)
``` 

## Abstract


## Nature of the Data
The data includes summary of both male and female spending as "both", so in order to perform an analysis on this data, we decided to exclude the both data points to avoid double counting? It is important to acknowledge that this data only included those who identified as either male or female, so this is not a complete representationof the population. 
```{r filter-for-gender, echo= FALSE, warning = FALSE}
spending_malefemale <- spending %>%
   filter(sex %in% c("Female", "Male"))
```

```{r distribution_pub, echo= FALSE, warning = FALSE, fig.height = 3, fig.width = 3}
spending_malefemale %>%
  ggplot(aes(x = mean_pub)) +
    geom_histogram(fill = "#28739F") +
    labs(title = "Normal Distribution of Mean Public Spending",
         x = "Mean Public Spending", 
         y = NULL)

```

```{r distribution_pri, echo= FALSE, warning = FALSE, fig.height = 3, fig.width = 3}
spending_malefemale %>%
  ggplot(aes(x = mean_pri)) +
    geom_histogram(fill = "#28739F") +
    labs(title = "Normal Distribution of Mean Private Spending",
         x = "Mean Private Spending", 
         y = NULL)

```

```{r distribution_oop, echo= FALSE, warning = FALSE, fig.height = 3, fig.width = 3}
spending_malefemale %>%
  ggplot(aes(x = mean_oop)) +
    geom_histogram(fill = "#28739F") +
    labs(title = "Normal Distribution of Mean Out-of-Pocket Spending",
         x = "Mean Out-of-Pocket Spending", 
         y = NULL)

```
The normal distribution for public spending, private spending, and out-of-pocket pending all show a severe right skew in the data. Therefore, all three variables do not meet the normal distribution assumption needed for many tests, such as ANOVA; however, this can easily be resolved by applying a log transformation to the data to give a fairly normal distribution of the data.

```{r log_pub, echo= FALSE, warning = FALSE, fig.height = 3, fig.width = 3}
spending_malefemale %>%
  ggplot(aes(x = log(mean_pub))) +
    geom_histogram(fill = "#28739F") +
    labs(title = "Log Normal Distribution of Mean Public Spending",
         x = "Log Mean Public Spending", 
         y = NULL)

```

```{r log_pri, echo= FALSE, warning = FALSE, fig.height = 3, fig.width = 3}
spending_malefemale %>%
  ggplot(aes(x = log(mean_pri))) +
    geom_histogram(fill = "#28739F") +
    labs(title = "Log Normal Distribution of Mean Private Spending",
         x = "Log Mean Private Spending", 
         y = NULL)

```

```{r log_oop, echo= FALSE, warning = FALSE, fig.height = 3, fig.width = 3}
spending_malefemale %>%
  ggplot(aes(x = log(mean_oop))) +
    geom_histogram(fill = "#28739F") +
    labs(title = "Log Normal Distribution of Mean Out-of-Pocket Spending",
         x = "Log Mean Out-of-Pocket Spending", 
         y = NULL)

```
These graphs of the log distribution of the various spending means appear to be fairly normal in distribution, which means they meet the requirements to be used in various analyses. In order to convert to log scale, those with mean_all, mean_pub, mean_pri, and mean_oop equal to zero must be excluded.

```{r logscaleconversion, echo= FALSE, warning = FALSE}
spending_malefemale <- spending_malefemale %>%
  filter(mean_all != 0) %>%
  filter(mean_pub != 0) %>%
  filter(mean_pri != 0) %>%
  filter(mean_oop != 0) %>%
  mutate(lmean_all = log(mean_all)) %>%
  mutate(lmean_pub = log(mean_pub)) %>%
  mutate(lmean_pri = log(mean_pri)) %>%
  mutate(lmean_oop = log(mean_oop))
  
```


## Gender
Our first question in this analysis is if males and females spend a different amount of money on emergency services.

First this t-test looks at overall differences in log mean emergency department spending between males and females
```{r gender-t-test, echo= FALSE, warning = FALSE}
  t.test(spending_malefemale$lmean_all~spending_malefemale$sex) %>%
  print()
```
This t-test shows that for mean spending of all emergency services payment types, the p value of 0.1543 (95% CI -0.0315862, 0.1996079) indicates there is not a significant difference between male and female spending. 

Next, we perform a t-test on each type of insurance to see if there is a difference in spending between males and females:
```{r gender-pubspending-ttest, echo= FALSE, warning = FALSE}
t.test(spending_malefemale$lmean_pub~spending_malefemale$sex) %>%
  print()
```
The t-test on emergency services spending for people who have public insurance indicates there is not a significant difference between male and female spending, with p value of 0.0697 (95% CI -0.00833746, 0.21532602).
```{r gender-prispending-ttest, echo= FALSE, warning = FALSE}
t.test(spending_malefemale$lmean_pri~spending_malefemale$sex) %>%
  print()
```
The t-test on emergency services spending for people who have private insurance indicates there is not a significant difference between male and female spending, with p value of 0.4803 (95% CI -0.08283085, 0.17603825).
```{r gender-oopspending-ttest, echo= FALSE, warning = FALSE}
t.test(spending_malefemale$lmean_oop~spending_malefemale$sex) %>%
  print()
```
The t-test on emergency services spending for people who pay out of pocket indicates there is not a significant difference between male and female spending, with p value of 0.3272 (95% CI -0.0615859, 0.1846904).

The t-tests for each type of insurance indicate that there is not enough evidence to reject the null hypothesis that emergency department spending is the same for males and females who have public insurance, private insurance, or pay out of pocket, leading us to the conclusion that gender does not influence emergency spending in the forms of payment studied here. 

## Disease category and Emergency Spending

In order to determine emergency department spending based on disease type, an ANOVA test is performed due to the data for spending on the log scale being normally distributed, relatively similar variance, and independent. 

The null hypothesis for this ANOVA test is that the overall mean of spending are the same for each disease category

```{r ANOVAtest, echo= FALSE, warning = FALSE}
summary(aov(lmean_all~agg_cause,data=spending_malefemale))
```

Based on the p-value here of <2e-16, these data or more extreme data it is highly unlikely the null hypothesis is true. Therefore, we perform step-down tests using a Holm correction for multiple comparisons.
```{r disease_pair, echo= FALSE, warning = FALSE}
diseasepair <- pairwise.t.test(spending_malefemale$lmean_all,    spending_malefemale$agg_cause, p.adj = "holm")
sigpairs <- broom::tidy(diseasepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigpairs)
```
The step-down t tests indicate 92 disease category pairs are different out of 105, indicating most disease categories do differ in the amount of government spending by the emergency department. There is lots of variation!!


```{r disease_fit, echo= FALSE, warning = FALSE}
meanalldiseasecatfit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_all ~ agg_cause, data = spending_malefemale)
  tidy(meanalldiseasecatfit)

```
```{r}
glance(meanalldiseasecatfit)$r.squared
```


## Age

!! had to take out the observations with "All Ages" because I think it will just mess up the pairs but let me know what you think or whether you think there's anything we can do with that group

```{r delete-allages, echo= FALSE, warning = FALSE}

spending_noall <- spending_malefemale %>%
  filter(age_group_name != "All Ages")

```


We wonder whether there is a correlation between government healthcare expenditures in the emergency department and age. The age variable is categorical, split into 19 groups that generally include 5 years each, apart from the first (<1 year) and last (85 plus) groups. 

To address this question, we began by using an overall test with ANOVA.

Below is an overall test of the null hypothesis that all of the means for age groups across the years are equal, as opposed to the alternative that at least one mean is different.

```{r age-anova, echo= FALSE, warning = FALSE}

summary(aov(lmean_all~age_group_name,data = spending_noall))

```

In this F-test (ndf = 18, ddf = 6229), a significant difference among age groups was identified. Our p-value tells us that this data (or data more extreme) would be very unlikely if the null hypothesis were true because it shows statistical significance at an alpha well below 0.05. Therefore, we reject the null hypothesis that the mean expenditures for all age groups are equal.

To see which specific means may be different from one another, we used planned step-down tests with a Holm correction to minimize Type I errors.

```{r age-stepdown, echo= FALSE, warning = FALSE}

agepair <- pairwise.t.test(spending_noall$lmean_all, spending_noall$age_group_name, p.adj = "holm")
sigagepairs <- broom::tidy(agepair) %>%
  filter(p.value<0.05) %>%
  arrange(group1,group2)
nrow(sigagepairs)

```

The pairwise t-tests used for our ANOVA step-down tests suggest that there are 99 different age pairs out of the 171 possible combinations. This tells us that more age pairs are different than are similar and that therefore the majority of age group pairs differ in terms of mean expenditures.
```{r}
agefit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_all ~ age_group_name, data = spending_malefemale)
  tidy(agefit)

```
```


```{r age-expenditure-barplot, echo= FALSE, warning = FALSE}
  # select the variables want, including the mean for the groups, age_group_name
  # pivot_longer -> cols, names_to = "whateveryouwant", values_to = "customname %>%
  # ggplot(aes(x = age_group_name, y = customname, color = whateveryouwant))
  
ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_all)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Age Group",
    y = "Mean Spending of All Payers (log scale)",
    title = "Emergency Department General Expenditures"
       )

```

```{r age-pub-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE, warning = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_pub)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = NULL,
    y = NULL,
    title = "Public Insurance Expenditures"
       )

```

```{r age-pri-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE, warning = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_pri)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = NULL,
    y = NULL,
    title = "Private Insurance Expenditures"
       )

```

```{r age-oop-barplot, fig.height = 2.5, fig.width = 6, echo = FALSE, warning = FALSE}

ggplot(data = spending_noall, aes(x = age_group_name, y = lmean_oop)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  scale_color_manual(values = c("#de9681")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = NULL,
    y = NULL,
    title = "Out of Pocket Expenditures"
       )

```


## Gender and Age Interaction
``` {r maineffects_pub, echo= FALSE, warning = FALSE}
mainefpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ sex + age_group_id, data = spending_malefemale)
tidy(mainefpub_fit)

glance(mainefpub_fit)$adj.r.squared
```

``` {r interaction_pub, echo= FALSE, warning = FALSE}
interpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ sex + age_group_id + sex*age_group_id, data = spending_malefemale)
tidy(interpub_fit)

glance(interpub_fit)$adj.r.squared
```


``` {r maineffects_pri, echo= FALSE, warning = FALSE}
mainefpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ sex + age_group_id, data = spending_malefemale)
tidy(mainefpri_fit)

glance(mainefpri_fit)$adj.r.squared
```

``` {r interaction_pri, echo= FALSE, warning = FALSE}
interpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ sex + age_group_id + sex*age_group_id, data = spending_malefemale)
tidy(interpri_fit)

glance(interpri_fit)$adj.r.squared
```



``` {r maineffects_oop, echo= FALSE, warning = FALSE}
mainefoop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ sex + age_group_id, data = spending_malefemale)
tidy(mainefoop_fit)

glance(mainefoop_fit)$adj.r.squared
```

``` {r interaction_oop, echo= FALSE, warning = FALSE}
interoop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ sex + age_group_id + sex*age_group_id, data = spending_malefemale)
tidy(interoop_fit)

glance(interoop_fit)$adj.r.squared
```

In order to test the possibility that there is a joint interaction of gender and age, a main effects and interaction effects linear regression model has been fit to the data. As a whole, it shows that the interaction of gender and age slightly increases the accuracy of the regression for public and private spending as seen by the increased adjusted R^2 value. However, for out-of-pocket spending, it decreases the adjusted R^2 value. Nevertheless, overall, the adjusted R^2 values for all three types of spending are incredibly low, which further point to our conclusion that age may not affect the level of spending from different sources.



## Age and Disease Type Interaction
``` {r agedismain_pub, echo= FALSE, warning = FALSE}
agedismainpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ agg_cause + age_group_id, data = spending_malefemale)
tidy(agedismainpub_fit)

glance(agedismainpub_fit)$adj.r.squared
```

``` {r agedisinter_pub, echo= FALSE, warning = FALSE}
agedisinterpub_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pub ~ agg_cause + age_group_id + agg_cause*age_group_id, data = spending_malefemale)
tidy(agedisinterpub_fit)

glance(agedisinterpub_fit)$adj.r.squared
```


``` {r agedismain_pri, echo= FALSE, warning = FALSE}
agedismainpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ agg_cause + age_group_id, data = spending_malefemale)
tidy(agedismainpri_fit)

glance(agedismainpri_fit)$adj.r.squared
```

``` {r agedisinter_pri, echo= FALSE, warning = FALSE}
agedisinterpri_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_pri ~ agg_cause + age_group_id + agg_cause*age_group_id, data = spending_malefemale)
tidy(agedisinterpri_fit)

glance(agedisinterpri_fit)$adj.r.squared
```



``` {r agedismain_oop, echo= FALSE, warning = FALSE}
agedismainoop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ agg_cause + age_group_id, data = spending_malefemale)
tidy(agedismainoop_fit)

glance(agedismainoop_fit)$adj.r.squared
```

``` {r agedisinter_oop, echo= FALSE, warning = FALSE}
agedisinteroop_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_oop ~ agg_cause + age_group_id + agg_cause*age_group_id, data = spending_malefemale)
tidy(agedisinteroop_fit)

glance(agedisinteroop_fit)$adj.r.squared
```

##Spending Over Time

!! I kinda like this but idk if it adds anything but it is fun, need to make the words smaller so you can read it
```{r spending_time_graph, echo= FALSE, warning = FALSE}
spending_malefemale %>%
  ggplot(aes(x = year_id,
             y = lmean_all,
             fill = agg_cause)) +
  geom_bar(stat = "identity") +
  facet_wrap(~agg_cause) +
  theme(axis.text.x = element_text(angle = 45,hjust = 1), legend.position = "none") +
  labs(x = "Disease Category",
       y = "Mean Spending (log$)")
```

!! can we divide this to have a predictor for each year?
```{r spending_time_fit, echo= FALSE, warning = FALSE}
spendingovertime_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(lmean_all ~ year_id, data = spending_malefemale)
tidy(spendingovertime_fit)

```



